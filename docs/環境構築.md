# 環境構築

## 前提条件

- Node.js 18以上
- npm または pnpm
- Discordアカウント
- Supabaseアカウント
- OpenAIアカウント
- Vercelアカウント

## 1. プロジェクトセットアップ

```bash
# プロジェクト作成
npx create-next-app@latest news-sender --typescript --tailwind --eslint --app --src-dir

cd news-sender

# 依存パッケージインストール
npm install @supabase/supabase-js openai discord-interactions rss-parser
npm install -D @types/node
```

## 2. Discord Application 作成

### 2.1 アプリケーション作成

1. [Discord Developer Portal](https://discord.com/developers/applications) にアクセス
2. 「New Application」をクリック
3. アプリ名を入力して作成

### 2.2 Bot設定

1. 左メニュー「Bot」を選択
2. 「Reset Token」でBot Tokenを取得（後で使用）
3. 「Privileged Gateway Intents」は不要

### 2.3 OAuth2設定

1. 左メニュー「OAuth2」→「URL Generator」
2. Scopes: `bot`, `applications.commands`
3. Bot Permissions: `Send Messages`
4. 生成されたURLでBotをサーバーに招待

### 2.4 Interactions Endpoint設定

1. 左メニュー「General Information」
2. 「Interactions Endpoint URL」に以下を設定:
   ```
   https://your-app.vercel.app/api/interactions
   ```
   ※ Vercelデプロイ後に設定

### 2.5 スラッシュコマンド登録

デプロイ後、以下のスクリプトで登録:

```typescript
// scripts/register-commands.ts
import { REST, Routes } from 'discord.js';

const commands = [
  {
    name: 'register',
    description: 'ユーザー登録を行います',
  },
  {
    name: 'theme',
    description: 'テーマを管理します',
    options: [
      {
        name: 'add',
        description: 'テーマを追加',
        type: 1, // SUB_COMMAND
        options: [
          {
            name: 'name',
            description: 'テーマ名',
            type: 3, // STRING
            required: true,
          },
        ],
      },
      {
        name: 'list',
        description: 'テーマ一覧を表示',
        type: 1,
      },
      {
        name: 'remove',
        description: 'テーマを削除',
        type: 1,
        options: [
          {
            name: 'name',
            description: 'テーマ名',
            type: 3,
            required: true,
          },
        ],
      },
    ],
  },
  {
    name: 'settings',
    description: '配信設定を管理します',
    options: [
      {
        name: 'count',
        description: '配信件数を設定',
        type: 1,
        options: [
          {
            name: 'number',
            description: '件数（1-30）',
            type: 4, // INTEGER
            required: true,
            min_value: 1,
            max_value: 30,
          },
        ],
      },
      {
        name: 'toggle',
        description: '配信のON/OFFを切り替え',
        type: 1,
      },
      {
        name: 'status',
        description: '現在の設定を表示',
        type: 1,
      },
    ],
  },
];

const rest = new REST({ version: '10' }).setToken(process.env.DISCORD_BOT_TOKEN!);

async function main() {
  await rest.put(
    Routes.applicationCommands(process.env.DISCORD_APPLICATION_ID!),
    { body: commands }
  );
  console.log('Commands registered!');
}

main();
```

## 3. Supabase設定

### 3.1 プロジェクト作成

1. [Supabase](https://supabase.com) にログイン
2. 「New Project」でプロジェクト作成
3. リージョン: Northeast Asia (Tokyo)を推奨

### 3.2 pgvector拡張有効化

1. Dashboard → Database → Extensions
2. `vector` を検索して有効化

### 3.3 テーブル作成

SQL Editorで以下を実行:

```sql
-- pgvector拡張
CREATE EXTENSION IF NOT EXISTS vector;

-- usersテーブル
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  discord_id TEXT NOT NULL UNIQUE,
  article_count INTEGER NOT NULL DEFAULT 10,
  is_active BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_users_discord_id ON users(discord_id);
CREATE INDEX idx_users_is_active ON users(is_active);

-- themesテーブル
CREATE TABLE themes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  embedding vector(1536) NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id, name)
);

CREATE INDEX idx_themes_user_id ON themes(user_id);

-- articlesテーブル
CREATE TABLE articles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  url TEXT NOT NULL UNIQUE,
  title TEXT NOT NULL,
  description TEXT,
  source TEXT NOT NULL,
  embedding vector(1536) NOT NULL,
  published_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_articles_url ON articles(url);
CREATE INDEX idx_articles_source ON articles(source);
CREATE INDEX idx_articles_created_at ON articles(created_at);

-- delivered_articlesテーブル
CREATE TABLE delivered_articles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  article_id UUID NOT NULL REFERENCES articles(id) ON DELETE CASCADE,
  delivered_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id, article_id)
);

CREATE INDEX idx_delivered_user_id ON delivered_articles(user_id);
CREATE INDEX idx_delivered_article_id ON delivered_articles(article_id);
```

### 3.4 API Keys取得

1. Dashboard → Settings → API
2. `URL` と `service_role key` をコピー

## 4. OpenAI API設定

1. [OpenAI Platform](https://platform.openai.com) にログイン
2. API Keys → Create new secret key
3. キーを保存

## 5. 環境変数設定

### ローカル開発用

`.env.local` を作成:

```env
# Discord
DISCORD_APPLICATION_ID=your_application_id
DISCORD_PUBLIC_KEY=your_public_key
DISCORD_BOT_TOKEN=your_bot_token

# Supabase
SUPABASE_URL=https://xxxxx.supabase.co
SUPABASE_SERVICE_KEY=your_service_role_key

# OpenAI
OPENAI_API_KEY=sk-xxxxx

# Cron認証（任意の文字列）
CRON_SECRET=your_random_secret_string
```

### Vercel用

Vercel Dashboard → Settings → Environment Variables に同じ変数を設定

## 6. Vercel設定

### 6.1 プロジェクトデプロイ

```bash
# Vercel CLIインストール
npm i -g vercel

# デプロイ
vercel
```

### 6.2 Cron Jobs設定

`vercel.json` を作成:

```json
{
  "crons": [
    {
      "path": "/api/cron/fetch",
      "schedule": "0 21 * * *"
    },
    {
      "path": "/api/cron/deliver",
      "schedule": "0 0 * * *"
    }
  ]
}
```

※ VercelのCronはUTC。日本時間に変換:
- 記事取得 6:00 JST = 21:00 UTC (前日)
- 配信 9:00 JST = 0:00 UTC

### 6.3 Discord Interactions Endpoint設定

1. デプロイ完了後、URLを確認
2. Discord Developer Portal → General Information
3. Interactions Endpoint URL に設定:
   ```
   https://your-app.vercel.app/api/interactions
   ```

## 7. 動作確認

### スラッシュコマンド登録

```bash
npx ts-node scripts/register-commands.ts
```

### テスト

1. Discordで `/register` を実行
2. `/theme add React` でテーマ追加
3. `/theme list` で確認

## ディレクトリ構成

```txt
news-sender/
├── src/
│   ├── app/
│   │   └── api/
│   │       ├── interactions/
│   │       │   └── route.ts
│   │       └── cron/
│   │           ├── fetch/
│   │           │   └── route.ts
│   │           └── deliver/
│   │               └── route.ts
│   ├── lib/
│   │   ├── discord.ts
│   │   ├── supabase.ts
│   │   ├── openai.ts
│   │   └── sources/
│   │       ├── qiita.ts
│   │       ├── zenn.ts
│   │       └── hatena.ts
│   └── types/
│       └── index.ts
├── scripts/
│   └── register-commands.ts
├── docs/
│   ├── 要件定義.md
│   ├── 技術設計.md
│   ├── DB設計.md
│   └── 環境構築.md
├── vercel.json
├── .env.local
└── package.json
```

## トラブルシューティング

### Discord Interactions Endpoint検証失敗

- 署名検証のコードが正しいか確認
- `DISCORD_PUBLIC_KEY` が正しいか確認

### Cron Jobが動かない

- Vercelの無料プランではCron Jobsは1日1回まで
- Pro以上で複数回実行可能

### Embedding生成エラー

- OpenAI APIキーの残高確認
- レート制限に注意（リトライ処理を実装）
