# セキュリティ対策

## 対応済み脆弱性

### CVE-2025-55182 (React Server Components RCE)

**概要**: React Server Components における認証不要のリモートコード実行脆弱性

**影響範囲**:

- react-server-dom-webpack/parcel/turbopack (19.0〜19.2.0)
- Next.js 14.3.0-canary.77以降、15.x、16.x

**本プロジェクトの状態**: ✅ 最新版で対策済み

- Next.js 16.0.7 を使用（修正済みバージョン）
- React 19.2.1 を使用（修正済みバージョン）

**参考**: <https://www.jpcert.or.jp/newsflash/2025120501.html>

### NPMサプライチェーン攻撃対策

**概要**: 2025年9月に発見された約500パッケージに影響するサプライチェーン攻撃

**対策状況**:

| 対策 | 状態 |
|------|------|
| npm audit による脆弱性スキャン | ✅ 実施済み（0 vulnerabilities） |
| package-lock.json による依存関係固定 | ✅ 設定済み |
| .npmrc セキュリティ設定 | ✅ 設定済み |
| Dependabot 自動更新 | ✅ 設定済み |
| GitHub Actions セキュリティ監査 | ✅ 設定済み |

**参考**: <https://www.trendmicro.com/ja_jp/research/25/i/npm-supply-chain-attack.html>

## セキュリティ設定ファイル

### .npmrc

```ini
# package-lock.json を厳格に使用
package-lock=true

# 整合性チェック
engine-strict=true

# 監査を強制
audit=true
audit-level=high

# 公式レジストリのみ使用
registry=https://registry.npmjs.org/
```

### GitHub Actions

- **security-audit.yml**: 毎日自動で `npm audit` を実行
- **dependabot.yml**: 依存関係の自動更新PR作成

## 運用ガイドライン

### 定期的なセキュリティチェック

```bash
# 脆弱性スキャン
npm audit

# 依存関係の更新確認
npm outdated

# 依存関係ツリーの確認
npm ls --all
```

### 新しいパッケージ追加時の注意

1. **パッケージの評価**
   - ダウンロード数、メンテナンス状況を確認
   - 最終更新日が古すぎないか確認
   - GitHub stars、issues を確認

2. **インストール後の確認**

   ```bash
   npm audit
   ```

3. **lockfile のコミット**
   - `package-lock.json` を必ずコミットする

### インシデント対応

1. **脆弱性発見時**

   ```bash
   # 自動修正を試行
   npm audit fix

   # 破壊的変更を含む修正
   npm audit fix --force
   ```

2. **侵害されたパッケージ発見時**
   - 該当パッケージを即座に削除
   - 代替パッケージの検討
   - 認証情報のローテーション

### 認証情報の管理（dotenvx）

**dotenvx** を使用して環境変数を暗号化管理しています。

**仕組み**:

- `.env` - 暗号化された環境変数（Git管理OK）
- `.env.keys` - 秘密鍵（Git管理NG、gitignore済み）

**ローカル開発時**:

```bash
# 自動で復号化される
npm run dev
npm run register-commands
```

**新しい環境変数を追加する場合**:

```bash
# 1. .envに追記後、再暗号化
npx dotenvx encrypt
```

**別環境で復号化する場合**:

```bash
# .env.keysから秘密鍵を取得して設定
export DOTENV_PRIVATE_KEY="your-private-key"
npm run dev
```

**本番環境（Vercel）**:

- Vercelの環境変数に直接設定（暗号化不要）
- または `DOTENV_PRIVATE_KEY` を設定して自動復号化

## 参考リソース

- [JPCERT/CC](https://www.jpcert.or.jp/)
- [npm Security Advisories](https://www.npmjs.com/advisories)
- [GitHub Security Advisories](https://github.com/advisories)
- [CVE Database](https://cve.mitre.org/)
