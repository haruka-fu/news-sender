# 技術設計

## システム構成図

```txt
┌─────────────────────────────────────────────────────────────┐
│                        Vercel                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │ /api/interactions│  │ /api/cron/fetch │  │/api/cron/   │ │
│  │ (スラッシュCmd)  │  │ (記事取得)      │  │deliver      │ │
│  └────────┬────────┘  └────────┬────────┘  └──────┬──────┘ │
└───────────┼─────────────────────┼─────────────────┼─────────┘
            │                     │                 │
            ▼                     ▼                 ▼
┌───────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│     Discord       │  │   OpenAI API    │  │    Supabase     │
│  Interactions API │  │   Embedding     │  │   PostgreSQL    │
└───────────────────┘  └─────────────────┘  └─────────────────┘
            │                                       │
            ▼                                       │
┌───────────────────┐                              │
│   Discord DM      │◄─────────────────────────────┘
│   (記事配信)      │
└───────────────────┘
```

## API設計

### Discord Interactions

#### POST /api/interactions

Discord からのスラッシュコマンドを受け付けるエンドポイント。

**リクエスト検証**
- Discord の署名検証（`X-Signature-Ed25519`, `X-Signature-Timestamp`）

**対応コマンド**

| コマンド | 処理内容 |
|----------|----------|
| `/register` | usersテーブルにDiscord ID登録 |
| `/theme add [name]` | themesテーブルに追加、Embedding生成 |
| `/theme list` | ユーザーのテーマ一覧取得 |
| `/theme remove [name]` | themesテーブルから削除 |
| `/settings` | 配信設定の表示・更新 |

### Cron Jobs

#### GET /api/cron/fetch

**実行タイミング**: 毎日 6:00 JST

**処理フロー**:
1. 各データソースから記事取得
   - Qiita: RSS or API
   - Zenn: RSS
   - はてなブックマーク: RSS
2. 重複チェック（URLベース）
3. 新規記事のEmbedding生成（OpenAI API）
4. articlesテーブルに保存

```typescript
// 処理の流れ
async function fetchArticles() {
  const sources = [
    fetchQiitaTrend(),
    fetchZennTrend(),
    fetchHatenaBookmark(),
  ];

  const articles = await Promise.all(sources);
  const flattened = articles.flat();
  const newArticles = await filterExisting(flattened);
  const withEmbeddings = await generateEmbeddings(newArticles);
  await saveArticles(withEmbeddings);
}
```

#### GET /api/cron/deliver

**実行タイミング**: 毎日 9:00 JST

**処理フロー**:
1. 配信対象ユーザー取得（is_active = true）
2. 各ユーザーのテーマEmbedding取得
3. 当日の記事とコサイン類似度計算
4. 上位N件を選択
5. Discord DMで配信

```typescript
// 処理の流れ
async function deliverArticles() {
  const users = await getActiveUsers();

  for (const user of users) {
    const themes = await getUserThemes(user.id);
    const todayArticles = await getTodayArticles();
    const matched = await matchArticles(themes, todayArticles, user.article_count);
    await sendDiscordDM(user.discord_id, matched);
  }
}
```

## マッチングアルゴリズム

### Embedding生成

**モデル**: `text-embedding-3-small`
- 次元数: 1536
- コスト: $0.02 / 1M tokens

**テーマのEmbedding**
```typescript
// 入力例: "React"
// → OpenAI APIでEmbedding化して保存
```

**記事のEmbedding**
```typescript
// 入力: `${title} ${description}`
// → OpenAI APIでEmbedding化して保存
```

### 類似度計算

**コサイン類似度**を使用:

```typescript
function cosineSimilarity(a: number[], b: number[]): number {
  const dotProduct = a.reduce((sum, val, i) => sum + val * b[i], 0);
  const magnitudeA = Math.sqrt(a.reduce((sum, val) => sum + val * val, 0));
  const magnitudeB = Math.sqrt(b.reduce((sum, val) => sum + val * val, 0));
  return dotProduct / (magnitudeA * magnitudeB);
}
```

**マッチング処理**:
1. 各記事と全テーマの類似度を計算
2. 各記事の最大類似度を採用
3. 類似度降順でソート
4. 上位N件を返却

```typescript
async function matchArticles(
  themes: Theme[],
  articles: Article[],
  limit: number
): Promise<MatchedArticle[]> {
  const scored = articles.map(article => {
    const maxSimilarity = Math.max(
      ...themes.map(theme =>
        cosineSimilarity(article.embedding, theme.embedding)
      )
    );
    return { ...article, score: maxSimilarity };
  });

  return scored
    .sort((a, b) => b.score - a.score)
    .slice(0, limit);
}
```

## データソース詳細

### Qiita

**取得方法**: RSS (`https://qiita.com/popular-items/feed`)

**取得データ**:
- title: 記事タイトル
- link: 記事URL
- description: 概要
- pubDate: 公開日

### Zenn

**取得方法**: RSS (`https://zenn.dev/feed`)

**取得データ**:
- title: 記事タイトル
- link: 記事URL
- description: 概要
- pubDate: 公開日

### はてなブックマーク

**取得方法**: RSS (`https://b.hatena.ne.jp/hotentry/it.rss`)

**取得データ**:
- title: 記事タイトル
- link: 記事URL
- description: 概要
- date: ブックマーク日

## エラーハンドリング

### 記事取得失敗時
- 該当ソースをスキップ、他ソースは継続
- エラーログ記録

### Embedding生成失敗時
- リトライ（3回まで）
- 失敗した記事はスキップ

### Discord DM送信失敗時
- ユーザーがDMをブロックしている可能性
- エラーログ記録、次回配信で再試行しない

## セキュリティ

### Discord署名検証

```typescript
import { verifyKey } from 'discord-interactions';

function verifyDiscordRequest(req: Request): boolean {
  const signature = req.headers.get('X-Signature-Ed25519');
  const timestamp = req.headers.get('X-Signature-Timestamp');
  const body = await req.text();

  return verifyKey(body, signature, timestamp, PUBLIC_KEY);
}
```

### 環境変数

| 変数名 | 用途 |
|--------|------|
| DISCORD_APPLICATION_ID | Discord App ID |
| DISCORD_PUBLIC_KEY | 署名検証用 |
| DISCORD_BOT_TOKEN | DM送信用 |
| OPENAI_API_KEY | Embedding生成 |
| SUPABASE_URL | DB接続 |
| SUPABASE_SERVICE_KEY | DB接続（サーバー用） |
