# デプロイ手順

## 概要

1. Supabase セットアップ
2. Discord アプリ作成
3. OpenAI API キー取得
4. Vercel デプロイ
5. Discord コマンド登録
6. 動作確認

---

## 1. Supabase セットアップ

### 1.1 プロジェクト作成

1. [Supabase](https://supabase.com) にログイン
2. 「New Project」をクリック
3. 以下を設定:
   - Name: `news-sender`
   - Database Password: 安全なパスワードを設定
   - Region: `Northeast Asia (Tokyo)` 推奨
4. 「Create new project」をクリック

### 1.2 テーブル作成

1. 左メニュー「SQL Editor」をクリック
2. 「New query」をクリック
3. `scripts/setup-database.sql` の内容をコピー＆ペースト
4. 「Run」をクリック
5. 「Setup completed!」と表示されれば成功

### 1.3 API キー取得

1. 左メニュー「Project Settings」→「API」
2. 以下をメモ:
   - **Project URL**: `https://xxxxx.supabase.co`
   - **service_role key**: `eyJhbGciOiJ...`（secret扱い）

---

## 2. Discord アプリ作成

### 2.1 アプリケーション作成

1. [Discord Developer Portal](https://discord.com/developers/applications) にアクセス
2. 「New Application」をクリック
3. Name: `News Sender`（任意）
4. 「Create」をクリック

### 2.2 必要な情報をメモ

**General Information ページ:**
- **APPLICATION ID**: `123456789012345678`
- **PUBLIC KEY**: `abcdef123456...`

### 2.3 Bot 設定

1. 左メニュー「Bot」をクリック
2. 「Reset Token」をクリックしてトークン取得
   - **BOT TOKEN**: `MTIzNDU2Nzg5...`（secret扱い）
3. 以下の設定を確認:
   - PUBLIC BOT: ON（他ユーザーが招待できる場合）
   - MESSAGE CONTENT INTENT: OFF（不要）

### 2.4 OAuth2 設定（Bot招待URL生成）

1. 左メニュー「OAuth2」→「URL Generator」
2. SCOPES:
   - [x] `bot`
   - [x] `applications.commands`
3. BOT PERMISSIONS:
   - [x] `Send Messages`
4. 生成されたURLをコピー
5. ブラウザでURLを開き、Botを招待するサーバーを選択

---

## 3. OpenAI API キー取得

1. [OpenAI Platform](https://platform.openai.com) にログイン
2. 右上のアイコン →「API Keys」
3. 「Create new secret key」をクリック
4. Name: `news-sender`
5. キーをメモ: `sk-...`（secret扱い）

---

## 4. Vercel デプロイ

### 4.1 GitHub リポジトリ作成（まだの場合）

```bash
cd H:/_VSCode/Web/news-sender
git init
git add .
git commit -m "Initial commit"
git branch -M main
git remote add origin https://github.com/YOUR_USERNAME/news-sender.git
git push -u origin main
```

### 4.2 Vercel でデプロイ

1. [Vercel](https://vercel.com) にログイン
2. 「Add New」→「Project」
3. GitHubリポジトリ `news-sender` を選択
4. 「Import」をクリック

### 4.3 環境変数設定

「Environment Variables」で以下を追加:

| Name | Value |
|------|-------|
| `DISCORD_APPLICATION_ID` | Discord の APPLICATION ID |
| `DISCORD_PUBLIC_KEY` | Discord の PUBLIC KEY |
| `DISCORD_BOT_TOKEN` | Discord の BOT TOKEN |
| `SUPABASE_URL` | Supabase の Project URL |
| `SUPABASE_SERVICE_KEY` | Supabase の service_role key |
| `OPENAI_API_KEY` | OpenAI の API キー |
| `CRON_SECRET` | 任意の文字列（例: `my-secret-cron-key-12345`） |

5. 「Deploy」をクリック
6. デプロイ完了後、URLをメモ（例: `https://news-sender-xxx.vercel.app`）

---

## 5. Discord Interactions Endpoint 設定

1. [Discord Developer Portal](https://discord.com/developers/applications) に戻る
2. 作成したアプリを選択
3. 左メニュー「General Information」
4. **INTERACTIONS ENDPOINT URL** に以下を入力:
   ```
   https://your-app.vercel.app/api/interactions
   ```
5. 「Save Changes」をクリック
6. ✅ が表示されれば成功

---

## 6. スラッシュコマンド登録

### 6.1 ローカルで実行

```bash
cd H:/_VSCode/Web/news-sender

# .env.local を作成（まだの場合）
cp .env.example .env.local
# .env.local を編集して環境変数を設定

# コマンド登録
npm run register-commands
```

### 6.2 成功時の出力

```
Commands registered successfully!
Registered 3 commands:
  - /register
  - /theme
  - /settings
```

---

## 7. 動作確認

### 7.1 スラッシュコマンドテスト

Discordで以下を実行:

1. `/register` → 「登録が完了しました！」
2. `/theme add React` → 「テーマ「React」を追加しました！」
3. `/theme list` → テーマ一覧が表示される
4. `/settings status` → 現在の設定が表示される

### 7.2 Cron テスト（手動実行）

ブラウザまたはcurlで確認:

```bash
# 記事取得テスト
curl -H "Authorization: Bearer YOUR_CRON_SECRET" \
  https://your-app.vercel.app/api/cron/fetch

# 配信テスト
curl -H "Authorization: Bearer YOUR_CRON_SECRET" \
  https://your-app.vercel.app/api/cron/deliver
```

---

## トラブルシューティング

### Interactions Endpoint 検証失敗

- `DISCORD_PUBLIC_KEY` が正しいか確認
- Vercelの環境変数が設定されているか確認
- 再デプロイを試す

### スラッシュコマンドが表示されない

- コマンド登録から反映まで最大1時間かかる場合がある
- Discordアプリを再起動してみる

### Cron が動かない

- Vercel無料プランではCronは1日1回まで
- Pro以上で複数回実行可能
- 環境変数 `CRON_SECRET` が設定されているか確認

### DM が届かない

- BotがサーバーにいるかDiscordで確認
- ユーザーのDM設定を確認（サーバーメンバーからのDMを許可）
